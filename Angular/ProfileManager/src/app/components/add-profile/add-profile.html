<div class="max-w-[1000px] mx-auto px-4 py-6 min-h-screen bg-gray-100">
  @if (isPageLoading() && action() !== 'add') {
    <div class="flex flex-col items-center justify-center py-20 px-6 gap-4">
      <mat-spinner diameter="48"></mat-spinner>
      <span class="text-base text-gray-500 font-medium">Loading profile...</span>
    </div>
  } @else {
    @let mobileNumber = profileDetailForm.mobileNumber().value();
    <mat-card class="mx-auto shadow-md rounded-lg">
      <div class="flex items-center">
        <button mat-icon-button (click)="onCancel()">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <mat-card-header class="flex-1 flex items-center">
          <mat-card-title class="text-2xl md:text-[28px] font-semibold text-gray-900 m-0">{{
            title()
          }}</mat-card-title>
          @if (action() !== 'add') {
            <div class="flex items-center gap-4 pl-4 pt-2">
              <a target="_blank" href="https://wa.me/{{ mobileNumber?.replace('+', '') }}">
                <mat-icon>chat_add_on</mat-icon>
              </a>
              <a target="_blank" href="tel:{{ mobileNumber }}">
                <mat-icon>call</mat-icon>
              </a>
            </div>
          }
        </mat-card-header>
      </div>
      <mat-card-content class="p-4 md:p-6">
        <form (submit)="onSubmit($event)" class="flex flex-col gap-3 md:gap-4">
          <div class="flex flex-col md:flex-row gap-3 md:gap-4 w-full">
            <mat-form-field appearance="fill" class="w-full block">
              <mat-label>Name</mat-label>
              <input matInput placeholder="Full Name" [formField]="profileDetailForm.name" />
              @if (
                profileDetailForm.name().errors().length > 0 && profileDetailForm.name().touched()
              ) {
                <mat-error>{{ profileDetailForm.name().errors().at(0)?.message }}</mat-error>
              }
            </mat-form-field>
            <mat-form-field appearance="fill" class="w-full block">
              <mat-label>Profile Status</mat-label>
              <mat-select [formField]="profileDetailForm.profileStatusId">
                @for (status of PROFILE_STATUS_DATA | keyvalue; track status.key) {
                  <mat-option [value]="status.key">{{ status.value }}</mat-option>
                }
              </mat-select>

              @if (
                profileDetailForm.profileStatusId().errors().length > 0 &&
                profileDetailForm.profileStatusId().touched()
              ) {
                <mat-error>{{
                  profileDetailForm.profileStatusId().errors().at(0)?.message
                }}</mat-error>
              }
            </mat-form-field>
          </div>

          <div class="flex flex-col md:flex-row gap-3 md:gap-4 w-full">
            <mat-form-field appearance="fill" class="w-full block">
              <mat-label>Mobile Number</mat-label>
              <input
                matInput
                placeholder="+91XXXXXXXXXX"
                [formField]="profileDetailForm.mobileNumber"
              />
              @if (action() === 'view') {
                <button
                  mat-icon-button
                  matSuffix
                  type="button"
                  (click)="copyField('mobileNumber', mobileNumber, 'Mobile number')"
                  [matTooltip]="getCopyTooltip('mobileNumber')"
                >
                  <mat-icon>{{ getCopyIcon('mobileNumber') }}</mat-icon>
                </button>
              }

              @if (
                profileDetailForm.mobileNumber().errors().length > 0 &&
                profileDetailForm.mobileNumber().touched()
              ) {
                <mat-error>{{
                  profileDetailForm.mobileNumber().errors().at(0)?.message
                }}</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="fill" class="w-full block">
              <mat-label>Matrimony ID</mat-label>
              <input
                matInput
                placeholder="Matrimony Site Profile ID"
                [formField]="profileDetailForm.matrimonyId"
              />
              @if (action() === 'view') {
                <button
                  mat-icon-button
                  matSuffix
                  type="button"
                  (click)="
                    copyField(
                      'matrimonyId',
                      profileDetailForm.matrimonyId().value(),
                      'Matrimony ID'
                    )
                  "
                  [matTooltip]="getCopyTooltip('matrimonyId')"
                >
                  <mat-icon>{{ getCopyIcon('matrimonyId') }}</mat-icon>
                </button>
              }
              @if (
                profileDetailForm.matrimonyId().errors().length > 0 &&
                profileDetailForm.matrimonyId().touched()
              ) {
                <mat-error>{{ profileDetailForm.matrimonyId().errors().at(0)?.message }}</mat-error>
              }
            </mat-form-field>
          </div>

          <div class="flex flex-col md:flex-row gap-3 md:gap-4 w-full">
            <mat-form-field appearance="fill" class="flex-1 min-w-0 block">
              <mat-label>Zodiac Sign</mat-label>
              <mat-select
                [formField]="profileDetailForm.zodiacSign"
                placeholder="Select Zodiac Sign"
              >
                @for (sign of ZODIAC_SIGN_DATA | keyvalue; track sign.key; let i = $index) {
                  <mat-option [value]="sign.key">
                    {{ i + 1 }}. {{ sign.value.tanglish }} ({{ sign.value.english }})</mat-option
                  >
                }
              </mat-select>
              @if (
                profileDetailForm.zodiacSign().errors().length > 0 &&
                profileDetailForm.zodiacSign().touched()
              ) {
                <mat-error>{{ profileDetailForm.zodiacSign().errors().at(0)?.message }}</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="fill" class="flex-1 min-w-0 block">
              <mat-label>Star</mat-label>
              <mat-select
                (selectionChange)="onStarChange($event)"
                [formField]="profileDetailForm.star"
                placeholder="Birth Star"
              >
                @for (star of STARS_DATA | keyvalue; track star.key; let i = $index) {
                  <mat-option [value]="star.key"> {{ i + 1 }}. {{ star.key }}</mat-option>
                }
              </mat-select>
              @if (
                profileDetailForm.star().errors().length > 0 && profileDetailForm.star().touched()
              ) {
                <mat-error>{{ profileDetailForm.star().errors().at(0)?.message }}</mat-error>
              }
            </mat-form-field>
          </div>

          <div class="flex flex-col md:flex-row gap-3 md:gap-4 w-full">
            <mat-form-field appearance="fill" class="flex-1 min-w-0 block">
              <mat-label>Age</mat-label>
              <input matInput type="number" [formField]="profileDetailForm.age" />
              @if (
                profileDetailForm.age().errors().length > 0 && profileDetailForm.age().touched()
              ) {
                <mat-error>{{ profileDetailForm.age().errors().at(0)?.message }}</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="fill" class="flex-1 min-w-0 block">
              <mat-label>Star Match Score (0-10)</mat-label>
              <input matInput type="number" [formField]="profileDetailForm.starMatchScore" />
              @if (
                profileDetailForm.starMatchScore().errors().length > 0 &&
                profileDetailForm.starMatchScore().touched()
              ) {
                <mat-error>{{
                  profileDetailForm.starMatchScore().errors().at(0)?.message
                }}</mat-error>
              }
            </mat-form-field>
          </div>

          <div class="flex flex-col md:flex-row gap-3 md:gap-4 w-full">
            <mat-form-field appearance="fill" class="flex-1 min-w-0 block">
              <mat-label>State</mat-label>
              <mat-select
                (selectionChange)="onStateChange()"
                [formField]="profileDetailForm.state"
                placeholder="Select state"
              >
                @for (state of STATE_LIST; track state) {
                  <mat-option [value]="state">{{ state }}</mat-option>
                }
              </mat-select>
              @if (
                profileDetailForm.state().errors().length > 0 && profileDetailForm.state().touched()
              ) {
                <mat-error>{{ profileDetailForm.state().errors().at(0)?.message }}</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="fill" class="flex-1 min-w-0 block">
              <mat-label>City</mat-label>
              <mat-select
                [formField]="profileDetailForm.city"
                [placeholder]="
                  profileDetailForm.state().value() ? 'Select city' : 'Select state first'
                "
              >
                @for (city of selectedStateDistrictList(); track city) {
                  <mat-option [value]="city">{{ city }}</mat-option>
                }
              </mat-select>
              @if (
                profileDetailForm.city().errors().length > 0 && profileDetailForm.city().touched()
              ) {
                <mat-error>{{ profileDetailForm.city().errors().at(0)?.message }}</mat-error>
              }
            </mat-form-field>
          </div>

          <app-comments
            [formField]="profileDetailForm.comments"
            [action]="action()"
            (commentInputHasValue)="commentValueState.set($event)"
          ></app-comments>

          <!-- Action Buttons -->
          @if (action() !== 'view') {
            <div
              class="flex flex-col-reverse md:flex-row justify-end gap-3 md:gap-4 mt-6 pt-4 border-t border-gray-300"
            >
              <button
                mat-stroked-button
                type="button"
                (click)="onCancel()"
                class="px-6 h-12 text-base w-full md:w-auto"
                [disabled]="isSaving()"
              >
                Cancel
              </button>
              <button
                mat-raised-button
                color="primary"
                type="submit"
                class="px-8 h-12 text-base bg-teal-700 text-white flex items-center gap-2 justify-center hover:bg-teal-800 disabled:opacity-60 disabled:cursor-not-allowed w-full md:w-auto"
                [disabled]="isSaving() || profileDetailForm().invalid() || !commentValueState()"
              >
                @if (isSaving()) {
                  <mat-spinner diameter="20" class="inline-block"></mat-spinner>
                  <span>Saving...</span>
                } @else {
                  {{ action() === 'add' ? 'Add Profile' : 'Update Profile' }}
                }
              </button>
            </div>
          }
        </form>
      </mat-card-content>
    </mat-card>
  }
</div>
