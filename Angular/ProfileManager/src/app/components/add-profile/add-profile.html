<div class="max-w-[1000px] mx-auto px-4 py-6 min-h-screen bg-gray-100">
  @if (isPageLoading() && action() !== 'add') {
    <div class="flex flex-col items-center justify-center py-20 px-6 gap-4">
      <mat-spinner diameter="48"></mat-spinner>
      <span class="text-base text-gray-500 font-medium">Loading profile...</span>
    </div>
  } @else {
    <mat-card class="mx-auto shadow-md rounded-lg">
      <div class="flex items-center">
        <button mat-icon-button (click)="onCancel()">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <mat-card-header class="flex-1 flex items-center gap-5 py-4 px-6">
          <mat-card-title class="text-2xl md:text-[28px] font-semibold text-gray-900 m-0">{{
            title()
          }}</mat-card-title>
          @if (action() !== 'add') {
            <a
              target="_blank"
              href="https://wa.me/{{ profileForm.value.mobileNumber?.replace('+', '') }}"
            >
              <mat-icon>chat_add_on</mat-icon>
            </a>
            <a target="_blank" href="tel:{{ profileForm.value.mobileNumber }}">
              <mat-icon>call</mat-icon>
            </a>
          }
        </mat-card-header>
      </div>
      <mat-card-content class="p-4 md:p-6">
        <form
          [formGroup]="profileForm"
          (ngSubmit)="onSubmit()"
          class="flex flex-col gap-3 md:gap-4"
        >
          <div class="flex flex-col md:flex-row gap-3 md:gap-4 w-full">
            <mat-form-field appearance="fill" class="w-full block">
              <mat-label>Name</mat-label>
              <input matInput placeholder="Full Name" formControlName="name" />
              @if (profileForm.controls.name.invalid && profileForm.controls.name.touched) {
                <mat-error>{{ getErrorMessage('name') }}</mat-error>
              }
            </mat-form-field>
            <mat-form-field appearance="fill" class="w-full block">
              <mat-label>Profile Status</mat-label>
              <mat-select formControlName="profileStatusId">
                @for (status of profileStatuses; track status.value) {
                  <mat-option [value]="status.value">{{ status.label }}</mat-option>
                }
              </mat-select>
              @if (
                profileForm.controls.profileStatusId.invalid &&
                profileForm.controls.profileStatusId.touched
              ) {
                <mat-error>{{ getErrorMessage('profileStatusId') }}</mat-error>
              }
            </mat-form-field>
          </div>

          <div class="flex flex-col md:flex-row gap-3 md:gap-4 w-full">
            <mat-form-field appearance="fill" class="w-full block">
              <mat-label>Mobile Number</mat-label>
              <input matInput placeholder="+91XXXXXXXXXX" formControlName="mobileNumber" />
              @if (action() === 'view') {
                <button
                  mat-icon-button
                  matSuffix
                  type="button"
                  (click)="
                    copyField('mobileNumber', profileForm.value.mobileNumber, 'Mobile number')
                  "
                  [matTooltip]="getCopyTooltip('mobileNumber')"
                >
                  <mat-icon>{{ getCopyIcon('mobileNumber') }}</mat-icon>
                </button>
              }
              @if (
                profileForm.controls.mobileNumber.invalid &&
                profileForm.controls.mobileNumber.touched
              ) {
                <mat-error>{{ getErrorMessage('mobileNumber') }}</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="fill" class="w-full block">
              <mat-label>Matrimony ID</mat-label>
              <input
                matInput
                placeholder="Matrimony Site Profile ID"
                formControlName="matrimonyId"
              />
              @if (action() === 'view') {
                <button
                  mat-icon-button
                  matSuffix
                  type="button"
                  (click)="copyField('matrimonyId', profileForm.value.matrimonyId, 'Matrimony ID')"
                  [matTooltip]="getCopyTooltip('matrimonyId')"
                >
                  <mat-icon>{{ getCopyIcon('matrimonyId') }}</mat-icon>
                </button>
              }
              @if (
                profileForm.controls.matrimonyId.invalid && profileForm.controls.matrimonyId.touched
              ) {
                <mat-error>{{ getErrorMessage('matrimonyId') }}</mat-error>
              }
            </mat-form-field>
          </div>

          <div class="flex flex-col md:flex-row gap-3 md:gap-4 w-full">
            <mat-form-field appearance="fill" class="flex-1 min-w-0 block">
              <mat-label>Zodiac Sign</mat-label>
              <mat-select formControlName="zodiacSign" placeholder="Select Zodiac Sign">
                @for (sign of zodiacSigns; track sign.value; let i = $index) {
                  <mat-option [value]="sign.value"> {{ i + 1 }}. {{ sign.label }}</mat-option>
                }
              </mat-select>
              @if (
                profileForm.controls.zodiacSign.invalid && profileForm.controls.zodiacSign.touched
              ) {
                <mat-error>{{ getErrorMessage('zodiacSign') }}</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="fill" class="flex-1 min-w-0 block">
              <mat-label>Star</mat-label>
              <mat-select formControlName="star" placeholder="Birth Star">
                @for (star of stars; track star; let i = $index) {
                  <mat-option [value]="star"> {{ i + 1 }}. {{ star }}</mat-option>
                }
              </mat-select>
              @if (profileForm.controls.star.invalid && profileForm.controls.star.touched) {
                <mat-error>{{ getErrorMessage('star') }}</mat-error>
              }
            </mat-form-field>
          </div>

          <div class="flex flex-col md:flex-row gap-3 md:gap-4 w-full">
            <mat-form-field appearance="fill" class="flex-1 min-w-0 block">
              <mat-label>Age</mat-label>
              <input matInput type="number" formControlName="age" />
              @if (profileForm.controls.age.invalid && profileForm.controls.age.touched) {
                <mat-error>{{ getErrorMessage('age') }}</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="fill" class="flex-1 min-w-0 block">
              <mat-label>Star Match Score (0-10)</mat-label>
              <input matInput type="number" readonly formControlName="starMatchScore" />
              @if (
                profileForm.controls.starMatchScore.invalid &&
                profileForm.controls.starMatchScore.touched
              ) {
                <mat-error>{{ getErrorMessage('starMatchScore') }}</mat-error>
              }
            </mat-form-field>
          </div>

          <div class="flex flex-col md:flex-row gap-3 md:gap-4 w-full">
            <mat-form-field appearance="fill" class="flex-1 min-w-0 block">
              <mat-label>State</mat-label>
              <mat-select
                (selectionChange)="onStateChange()"
                formControlName="state"
                placeholder="Select state"
              >
                @for (state of states; track state) {
                  <mat-option [value]="state">{{ state }}</mat-option>
                }
              </mat-select>
              @if (profileForm.controls.state.invalid && profileForm.controls.state.touched) {
                <mat-error>{{ getErrorMessage('state') }}</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="fill" class="flex-1 min-w-0 block">
              <mat-label>City</mat-label>
              <mat-select
                formControlName="city"
                [placeholder]="
                  profileForm.controls.state.value ? 'Select city' : 'Select state first'
                "
              >
                @for (city of cities(); track city) {
                  <mat-option [value]="city">{{ city }}</mat-option>
                }
              </mat-select>
              @if (profileForm.controls.city.invalid && profileForm.controls.city.touched) {
                <mat-error>{{ getErrorMessage('city') }}</mat-error>
              }
            </mat-form-field>
          </div>

          <!-- Comments Section -->
          <div>
            <h3 class="text-base md:text-lg font-medium text-gray-700">Comments</h3>

            <div class="py-2">
              @if (comments().length > 0) {
                <div class="relative">
                  @for (comment of comments(); track $index) {
                    <div class="flex relative pb-6 last:pb-4">
                      <div class="flex flex-col items-center w-5 md:w-6 shrink-0 mr-3 md:mr-4">
                        <span
                          class="w-2.5 md:w-3 h-2.5 md:h-3 rounded-full bg-teal-700 border-2 border-teal-700 z-[1]"
                        ></span>
                        <span class="timeline-line w-0.5 flex-1 bg-gray-300 mt-1"></span>
                      </div>
                      <div class="flex-1 min-w-0">
                        <div
                          class="flex items-center gap-1.5 text-xs text-gray-500 mb-2 font-medium"
                        >
                          <mat-icon class="text-base w-4 h-4 text-gray-400">schedule</mat-icon>
                          {{ comment.createDateAndTime | date: 'MMM dd, yyyy hh:mm a' }}
                        </div>
                        <div
                          class="flex items-start justify-between gap-2 bg-gray-100 rounded-lg py-3 px-4 border-l-[3px] border-teal-700 shadow-sm"
                        >
                          <span class="flex-1 text-sm text-gray-700 leading-relaxed break-words">{{
                            comment.value
                          }}</span>
                          @if (action() !== 'view') {
                            <button
                              mat-icon-button
                              type="button"
                              class="delete-comment-btn shrink-0 w-7 h-7 -my-1 -mr-2"
                              (click)="removeComment($index)"
                              aria-label="Delete comment"
                            >
                              <mat-icon
                                class="text-lg w-[18px] h-[18px] text-gray-400 hover:text-red-600 transition-colors"
                                >close</mat-icon
                              >
                            </button>
                          }
                        </div>
                      </div>
                    </div>
                  }
                </div>
              } @else {
                <div
                  class="flex flex-col items-center justify-center py-8 px-4 bg-gray-50 rounded-lg text-gray-400"
                >
                  <mat-icon class="text-5xl w-12 h-12 mb-2">chat_bubble_outline</mat-icon>
                  <p class="m-0 text-sm">No comments yet</p>
                </div>
              }

              @if (action() !== 'view') {
                <div class="flex items-start mt-2">
                  <div class="hidden md:block mr-4">
                    <span
                      class="w-3 h-3 rounded-full bg-transparent border-2 border-dashed border-teal-700 block"
                    ></span>
                  </div>
                  <div class="flex flex-1 flex-col md:flex-row gap-2 md:gap-3 items-start">
                    <mat-form-field appearance="fill" class="flex-1 m-0 block w-full md:w-auto">
                      <mat-label>Add Comment</mat-label>
                      <input
                        matInput
                        [value]="newComment()"
                        (input)="newComment.set($any($event.target).value)"
                        (keyup.enter)="addComment()"
                        placeholder="Enter your comment"
                      />
                    </mat-form-field>
                    <button
                      mat-raised-button
                      type="button"
                      (click)="addComment()"
                      class="h-12 flex items-center gap-1 whitespace-nowrap bg-teal-700 text-white hover:bg-teal-800 disabled:bg-gray-400 disabled:text-gray-600 w-full md:w-auto md:mt-2"
                      [disabled]="!newComment().trim()"
                    >
                      <mat-icon class="mr-1">add</mat-icon>
                      Add
                    </button>
                  </div>
                </div>
              }
            </div>
          </div>

          <!-- Action Buttons -->
          @if (action() !== 'view') {
            <div
              class="flex flex-col-reverse md:flex-row justify-end gap-3 md:gap-4 mt-6 pt-4 border-t border-gray-300"
            >
              <button
                mat-stroked-button
                type="button"
                (click)="onCancel()"
                class="px-6 h-12 text-base w-full md:w-auto"
                [disabled]="isSaving()"
              >
                Cancel
              </button>
              <button
                mat-raised-button
                color="primary"
                type="submit"
                class="px-8 h-12 text-base bg-teal-700 text-white flex items-center gap-2 justify-center hover:bg-teal-800 disabled:opacity-60 disabled:cursor-not-allowed w-full md:w-auto"
                [disabled]="isSaving() || profileForm.invalid"
              >
                @if (isSaving()) {
                  <mat-spinner diameter="20" class="inline-block"></mat-spinner>
                  <span>Saving...</span>
                } @else {
                  {{ action() === 'add' ? 'Add Profile' : 'Update Profile' }}
                }
              </button>
            </div>
          }
        </form>
      </mat-card-content>
    </mat-card>
  }
</div>
